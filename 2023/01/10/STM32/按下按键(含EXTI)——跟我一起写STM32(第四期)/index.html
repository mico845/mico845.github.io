<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>按下按键(含EXTI)——跟我一起写STM32(第四期) | 瑞奇的博客</title><meta name="author" content="瑞奇"><meta name="copyright" content="瑞奇"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="6 按下按键 6.1 检测一个按键的按下 我们分析一下下面的原理图，不难看出，对于KEY0-KEY2这样的按钮，只要按下就与GND导通了。所以，我们要检测这个按钮是否按下，就可以读取这个按钮相应的GPIO的电平情况：检测为低电平就是有按钮按下。  1HAL_GPIO_ReadPin(GPIOx, GPIO_Pin) 有写就有读嘛，参数就是我们之前学的哪些参数，返回值就是高电平或者低电平(GPIO_">
<meta property="og:type" content="article">
<meta property="og:title" content="按下按键(含EXTI)——跟我一起写STM32(第四期)">
<meta property="og:url" content="https://rich-blog.cn/2023/01/10/STM32/%E6%8C%89%E4%B8%8B%E6%8C%89%E9%94%AE(%E5%90%ABEXTI)%E2%80%94%E2%80%94%E8%B7%9F%E6%88%91%E4%B8%80%E8%B5%B7%E5%86%99STM32(%E7%AC%AC%E5%9B%9B%E6%9C%9F)/index.html">
<meta property="og:site_name" content="瑞奇的博客">
<meta property="og:description" content="6 按下按键 6.1 检测一个按键的按下 我们分析一下下面的原理图，不难看出，对于KEY0-KEY2这样的按钮，只要按下就与GND导通了。所以，我们要检测这个按钮是否按下，就可以读取这个按钮相应的GPIO的电平情况：检测为低电平就是有按钮按下。  1HAL_GPIO_ReadPin(GPIOx, GPIO_Pin) 有写就有读嘛，参数就是我们之前学的哪些参数，返回值就是高电平或者低电平(GPIO_">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://rich-blog.cn/img/cover/cover_9.jpg">
<meta property="article:published_time" content="2023-01-10T15:06:13.000Z">
<meta property="article:modified_time" content="2023-02-26T04:02:07.076Z">
<meta property="article:author" content="瑞奇">
<meta property="article:tag" content="stm32">
<meta property="article:tag" content="单片机">
<meta property="article:tag" content="嵌入式">
<meta property="article:tag" content="c语言">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://rich-blog.cn/img/cover/cover_9.jpg"><link rel="shortcut icon" href="/img/panda.png"><link rel="canonical" href="https://rich-blog.cn/2023/01/10/STM32/%E6%8C%89%E4%B8%8B%E6%8C%89%E9%94%AE(%E5%90%ABEXTI)%E2%80%94%E2%80%94%E8%B7%9F%E6%88%91%E4%B8%80%E8%B5%B7%E5%86%99STM32(%E7%AC%AC%E5%9B%9B%E6%9C%9F)/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-right"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '按下按键(含EXTI)——跟我一起写STM32(第四期)',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-02-26 12:02:07'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = url => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      link.onload = () => resolve()
      link.onerror = () => reject()
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-tag-plugins@latest/lib/tag_plugins.min.css" media="defer" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/hexo-tag-plugins@latest/lib/carousel-touch.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-tag-plugins@latest/lib/mindmap.min.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="瑞奇的博客" type="application/atom+xml">
<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet" /></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/pearl.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">29</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/life/"><i class="fa-fw fas fa-globe"></i><span> 生活</span></a></li><li><a class="site-page child" href="/table/"><i class="fa-fw fas fa-table-list"></i><span> 课程表</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/cover/cover_9.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="瑞奇的博客"><span class="site-name">瑞奇的博客</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/life/"><i class="fa-fw fas fa-globe"></i><span> 生活</span></a></li><li><a class="site-page child" href="/table/"><i class="fa-fw fas fa-table-list"></i><span> 课程表</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">按下按键(含EXTI)——跟我一起写STM32(第四期)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-01-10T15:06:13.000Z" title="发表于 2023-01-10 23:06:13">2023-01-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-02-26T04:02:07.076Z" title="更新于 2023-02-26 12:02:07">2023-02-26</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%B7%9F%E6%88%91%E4%B8%80%E8%B5%B7%E5%86%99STM32/">跟我一起写STM32</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>14分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="按下按键(含EXTI)——跟我一起写STM32(第四期)"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="6-按下按键">6 按下按键</h1>
<h2 id="6-1-检测一个按键的按下">6.1 检测一个按键的按下</h2>
<p>我们分析一下下面的原理图，不难看出，对于KEY0-KEY2这样的按钮，只要按下就与GND导通了。所以，我们要检测这个按钮是否按下，就可以读取这个按钮相应的GPIO的电平情况：检测为低电平就是有按钮按下。<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/bfeb6bbc909f4ff38d5c53bbc0258c24.png" alt=""></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HAL_GPIO_ReadPin(GPIOx, GPIO_Pin)</span><br></pre></td></tr></table></figure>
<p>有写就有读嘛，参数就是我们之前学的哪些参数，返回值就是高电平或者低电平<code>(GPIO_PIN_SET/GPIO_PIN_RESET)</code><br>
那代码的核心思想有了，我们再来想想流程：<br>
<strong>（基础三件套以后就不重复了：时钟树(先使能RCC)，Debug工具配置，勾选生成.c/.h）</strong><br>
<strong>1. 配置GPIO</strong></p>
<p>a) 输入/输出（既然要读它的电平，那么这次就得是配置为输入模式了）</p>
<p>b) 电气属性：</p>
<p>GPIO 速度：GPIO速度上我们不作要求<br>
GPIO上/下拉：上拉。这样可以保证在我们按下按钮之前这个GPIO的电平为高电平。<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/7f97c48f7e374806a74a4877adc7cdc1.png" alt=""><br>
<strong>2. 检测方式</strong>：这里我们先用最简单的方式while+if来检测按键按下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* USER CODE BEGIN WHILE */</span></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">  &#123;</span><br><span class="line">	  <span class="keyword">if</span>(GPIO_PIN_RESET == HAL_GPIO_ReadPin(KEY1_GPIO_Port,KEY1_Pin))</span><br><span class="line">	  &#123;</span><br><span class="line">		  HAL_GPIO_TogglePin(LED1_GPIO_Port, LED1_Pin);</span><br><span class="line">	  &#125;</span><br><span class="line"><span class="comment">/* USER CODE END WHILE */</span></span><br></pre></td></tr></table></figure>
<h2 id="6-2-给按键消抖">6.2 给按键消抖</h2>
<p>不过，很多朋友还是发现这样的按钮时不时会失灵，这是为什么呢？<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/40835d4581de4df29aac775573752943.png" alt=""><br>
这其实就是因为我们按下按钮的时候产生了抖动</p>
<p>不过我们可以给按钮加一些延时来跳过这些抖动<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/0fdd1b536a2d4119b4674c1425b92a59.png#pic_center" alt=""><br>
代码实现就是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* USER CODE BEGIN WHILE */</span></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">  &#123;</span><br><span class="line">	  <span class="keyword">if</span>(GPIO_PIN_RESET == HAL_GPIO_ReadPin(KEY1_GPIO_Port,KEY1_Pin))</span><br><span class="line">	  &#123;</span><br><span class="line">		  HAL_Delay(<span class="number">20</span>);</span><br><span class="line">		  HAL_GPIO_TogglePin(LED1_GPIO_Port, LED1_Pin);</span><br><span class="line">		  <span class="keyword">while</span>(GPIO_PIN_RESET == HAL_GPIO_ReadPin(KEY1_GPIO_Port,KEY1_Pin));</span><br><span class="line">		  HAL_Delay(<span class="number">20</span>);</span><br><span class="line">	  &#125;</span><br><span class="line"><span class="comment">/* USER CODE END WHILE */</span></span><br></pre></td></tr></table></figure>
<p>这样我们的按钮至少很听话了。</p>
<h2 id="6-3-扫描按键">6.3 扫描按键</h2>
<p>假如我们的按键很多，那么就需要扫描按键。<br>
创建HardWare/key</p>
<p>key.h</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by Whisky on 2023/1/8.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> HELLOWORLD_KEY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HELLOWORLD_KEY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;main.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY2_Pin GPIO_PIN_2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY2_GPIO_Port GPIOE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY1_Pin GPIO_PIN_3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY1_GPIO_Port GPIOE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY0_Pin GPIO_PIN_4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY0_GPIO_Port GPIOE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEYWKUP_Pin GPIO_PIN_0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEYWKUP_GPIO_Port GPIOA</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __KEY_ALL_CLK_ON() do&#123;__HAL_RCC_GPIOA_CLK_ENABLE();__HAL_RCC_GPIOE_CLK_ENABLE();&#125;while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY0        HAL_GPIO_ReadPin(KEY0_GPIO_Port,KEY0_Pin)  <span class="comment">//KEY0按键PE4</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY1        HAL_GPIO_ReadPin(KEY1_GPIO_Port,KEY1_Pin)  <span class="comment">//KEY1按键PE3</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY2        HAL_GPIO_ReadPin(KEY2_GPIO_Port,KEY2_Pin) 	<span class="comment">//KEY2按键PE2</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WK_UP       HAL_GPIO_ReadPin(KEYWKUP_GPIO_Port,KEYWKUP_Pin)  <span class="comment">//WKUP按键PA0</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY0_PRES 	    1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY1_PRES	    2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY2_PRES	    3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEYWKUP_PRES    4</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">key_init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">key_scan</span><span class="params">(<span class="type">uint8_t</span> mode)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//HELLOWORLD_KEY_H</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>key.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by Whisky on 2023/1/8.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;key.h&quot;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">key_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    GPIO_InitTypeDef GPIO_Initure;</span><br><span class="line">    __KEY_ALL_CLK_ON();</span><br><span class="line"></span><br><span class="line">    GPIO_Initure.Mode=GPIO_MODE_INPUT;</span><br><span class="line">    GPIO_Initure.Pull=GPIO_PULLDOWN;</span><br><span class="line">    GPIO_Initure.Speed=GPIO_SPEED_FREQ_HIGH;</span><br><span class="line">    GPIO_Initure.Pin=KEYWKUP_Pin;</span><br><span class="line">    HAL_GPIO_Init(KEYWKUP_GPIO_Port,&amp;GPIO_Initure);</span><br><span class="line"></span><br><span class="line">    GPIO_Initure.Mode=GPIO_MODE_INPUT;</span><br><span class="line">    GPIO_Initure.Pull=GPIO_PULLUP;</span><br><span class="line">    GPIO_Initure.Speed=GPIO_SPEED_FREQ_HIGH;</span><br><span class="line">    GPIO_Initure.Pin=KEY0_Pin;</span><br><span class="line">    HAL_GPIO_Init(KEY0_GPIO_Port,&amp;GPIO_Initure);</span><br><span class="line">    GPIO_Initure.Pin=KEY1_Pin;</span><br><span class="line">    HAL_GPIO_Init(KEY1_GPIO_Port,&amp;GPIO_Initure);</span><br><span class="line">    GPIO_Initure.Pin=KEY2_Pin;</span><br><span class="line">    HAL_GPIO_Init(KEY2_GPIO_Port,&amp;GPIO_Initure);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//同时按下的优先级 ： KEYWKUP &gt; KEY2 &gt; KEY1 &gt; KEY0</span></span><br><span class="line"><span class="comment">//mode : 0  不连续按 当按键按下不放时，只返回第一次按下的值</span></span><br><span class="line"><span class="comment">//       1  连续按   当按键按下不放时，每次调用这个函数都会返回值</span></span><br><span class="line"></span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">key_scan</span><span class="params">(<span class="type">uint8_t</span> mode)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">uint8_t</span> key_up=<span class="number">1</span>;     <span class="comment">//按键松开标志</span></span><br><span class="line">    <span class="keyword">if</span>(mode==<span class="number">1</span>)key_up=<span class="number">1</span>;    <span class="comment">//支持连按</span></span><br><span class="line">    <span class="keyword">if</span>(key_up&amp;&amp;(KEY0==<span class="number">0</span>||KEY1==<span class="number">0</span>||KEY2==<span class="number">0</span>||WK_UP==<span class="number">1</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        delay_ms(<span class="number">10</span>);</span><br><span class="line">        key_up=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(KEY0==<span class="number">0</span>)       <span class="keyword">return</span> KEY0_PRES;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(KEY1==<span class="number">0</span>)  <span class="keyword">return</span> KEY1_PRES;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(KEY2==<span class="number">0</span>)  <span class="keyword">return</span> KEY2_PRES;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(WK_UP==<span class="number">1</span>) <span class="keyword">return</span> KEYWKUP_PRES;</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(KEY0==<span class="number">1</span>&amp;&amp;KEY1==<span class="number">1</span>&amp;&amp;KEY2==<span class="number">1</span>&amp;&amp;WK_UP==<span class="number">0</span>)key_up=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;   <span class="comment">//无按键按下</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里主要参考了原子的代码，扫描的时候按键消抖延时也不能太久，不然会出现“读太慢”现象。<br>
这样我们在<code>while</code>中调用<code>key_sacn</code>就能实现对多个按键的扫描了。</p>
<h2 id="6-4-引入中断-中断向量表">6.4 引入中断——中断向量表</h2>
<p>不过，有的时候，我们需要做一些别的事情，而不能用一直轮询的方式检测按键(即在<code>while</code>中调用<code>key_sacn</code>)。毕竟，一直轮询的方式检测按键的电平实在是太过浪费咱们CPU的处理能力，这种事情其实可以交给外部中断来处理。<br>
处理器中的中断：在处理器中，中断是一个过程，即CPU在正常执行程序的过程中，遇到外部/内部的紧急事件需要处理，暂时中止当前程序的执行，转而去为处理紧急的事件，待处理完毕后再返回被打断的程序处继续往下执行。中断在计算机多任务处理，尤其是即时系统中尤为重要。比如uCOS，FreeRTOS等。<br>
意义：中断能提高CPU的效率，同时能对突发事件做出实时处理。实现程序的并行化，实现嵌入式系统进程之间的切换。<br>
那有朋友就要问了，它是怎么实现的呢？<br>
这里不得不提到中断向量表了。<br>
我们打开/Core/Startup 里面的.s文件，这是一个由arm汇编编写的stm32的启动文件，它的工作主要是：</p>
<ol>
<li>设置堆栈指针 SP = _initial_sp</li>
<li>设置PC指针 = Reset_Handler</li>
<li>配置系统时钟</li>
<li>配置外部 SRAM 用于程序变量等数据存储（可选）</li>
<li>调用C库的 _main 函数，最终调用main函数</li>
</ol>
<p>我们主要看一下我们的主角：中断向量表<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/f7c30dcb553b4261a6df50a2f0a411f4.png" alt=""><br>
这里写出了很多当发生了某个事件就要执行对应中断服务函数的清单，这就是中断向量表。<br>
一些非一开始就要用上的中断服务函数，HAL库进行了虚函数处理（__weak函数用于定义变量或者函数，常见于定义函数，在MDK ARM链接时优先链接定义为非weak的函数或变量，如果找不到则再链接weak函数，默认的一般里面也是空函数）<br>
而我们重写了的中断服务函数的处理过程一般就是</p>
<p>进入中断：<br>
(1)保存现场(XPSR、PC、LR、R12、R3、R2、R1 和 R0 这 8 个寄存器，具体含义可以参考arm体系结构)到堆栈里面<br>
(2)一旦入栈结束，ISR（中断服务例程，就是中断服务函数）便开始执行<br>
晚到的中断会重新取ISR地址，但无需再次保存现场(晚到中断机制)</p>
<p>退出中断：<br>
(1)中断前的现场被自动从堆栈中恢复<br>
(2)一旦出栈完成，继续执行被中断打断的指令<br>
出栈的过程也可被打断，使得随时可以响应新的中断，而不再进行现场保存(咬尾中断机制)</p>
<p>这里我们可以知道：中断操作有三部曲：<strong>入栈+ISR+出栈</strong><br>
采用了咬尾中断机制和晚到中断机制来避免对一次连续的嵌套中断反复出入栈，浪费时间的操作。</p>
<h2 id="6-5-引入中断-中断优先级">6.5 引入中断——中断优先级</h2>
<p>其实刚刚提到中断嵌套的时候就有朋友发现了，中断是有优先级的<br>
STM32的中断有两种优先级：1、抢占式优先级 2、响应式优先级。</p>
<p><strong>抢占式优先级</strong>的特点是：具有高抢占式优先级的中断可以在具有低<strong>抢占</strong>式优先级的中断处理过程中被响应，即<strong>中断嵌套</strong>。</p>
<p><strong>响应式优先级</strong>的特点是：当两个中断源的抢占式优先级相同时，高响应优先级的中断优先被响应，这两个中断将<strong>没有嵌套关系</strong>。</p>
<p>相同时，如果有低响应优先级中断正在执行，那么高响应优先级的中断要等待已被响应的低响应优先级的中断执行结束后才能得到响应。当一个中断到来后，如果正在处理另一个中断，这个后到来的中断就要等到前一个中断处理完之后才能被处理。如果这两个中断同时到达，则中断控制器根据他们的响应优先级高低来决定先处理哪一个；如果他们的抢占式优先级和响应优先级都相等，则根据他们在中断表中的排位顺序决定先处理哪一个。每一个中断源都必须定义2个优先级。</p>
<p>STM32设置了组（Group）的概念来管理这些优先级。每一个中断都有一个专门的寄存器（Interrupt Priority Registers）来描述该中断的抢占式优先级和响应式优先级。在这个寄存器中STM32使用了4个二进制位来描述优先级。4位的中断优先级可以分成2组，从高位看，前面定义的是抢占式优先级，后面是响应优先级。按照这种分组，4位一共可以分成5组，分别为：</p>
<p>第0组：所有4位用于指定响应式优先级；<br>
第1组：最高1位用于指定抢占式优先级，后面3位用于指定响应式优先级；<br>
第2组：最高2位用于指定抢占式优先级，后面2位用于指定响应式优先级；<br>
第3组：最高3位用于指定抢占式优先级，后面1位用于指定响应式优先级；<br>
第4组：所有4位用于指定抢占式优先级。</p>
<p>这里是HAL库的宏，可以眼熟一下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> NVIC_PriorityGroup_0         ((uint32_t)0x700) <span class="comment">/*!&lt; 0 bits for pre-emption priority</span></span></span><br><span class="line"><span class="comment"><span class="meta">                                                            4 bits for subpriority */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NVIC_PriorityGroup_1         ((uint32_t)0x600) <span class="comment">/*!&lt; 1 bits for pre-emption priority</span></span></span><br><span class="line"><span class="comment"><span class="meta">                                                            3 bits for subpriority */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NVIC_PriorityGroup_2         ((uint32_t)0x500) <span class="comment">/*!&lt; 2 bits for pre-emption priority</span></span></span><br><span class="line"><span class="comment"><span class="meta">                                                            2 bits for subpriority */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NVIC_PriorityGroup_3         ((uint32_t)0x400) <span class="comment">/*!&lt; 3 bits for pre-emption priority</span></span></span><br><span class="line"><span class="comment"><span class="meta">                                                            1 bits for subpriority */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NVIC_PriorityGroup_4         ((uint32_t)0x300) <span class="comment">/*!&lt; 4 bits for pre-emption priority</span></span></span><br><span class="line"><span class="comment"><span class="meta">                                                            0 bits for subpriority */</span></span></span><br></pre></td></tr></table></figure>
<p>知道了这些概念，我们再用NVIC串一下知识<br>
NVIC的全称是Nested vectoredinterrupt controller，即嵌套向量中断控制器。<br>
功能：</p>
<ol>
<li>中断管理-&gt;使能或者禁止中断</li>
<li>支持异常及中断向量化处理-&gt;采用向量表处理异常，M0处理器会从存储器的向量表中，自动定位异常的程序入口</li>
<li>支持嵌套中断-&gt;中断优先级的管理</li>
</ol>
<h2 id="6-6-按键的检测-外部中断exti">6.6 按键的检测——外部中断EXTI</h2>
<p>我们直接上手册<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/d0bb04fdab7c4a538f7145ac573bbeda.png#pic_center" alt=""><br>
外部信号进入经过1的边沿检测电路，检测是否符合(有2和3的上升沿和下降沿选择寄存器决定)，产生信号，然后和4软件中断事件寄存器或值，(在这里也就说可以写入软件中断事件寄存器模拟中断和事件)，之后产生信号一分为二，看5挂起屏蔽寄存器和7事件屏蔽寄存器，中断挂起，如果事件没有屏蔽，首先会产生事件，进入脉冲发生器。如果6中断屏蔽寄存器也没有屏蔽，则然后进入NVIC。</p>
<p>基本的外部中断就是MCU上GPIO引脚作为输入引脚时，电平变化产生的中断。<br>
GPIO的映射关系图如下所示</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/c0e53c38f2f8485cb51fa4af4a2c3ebd.png" alt=""><br>
那我们检测按键需要干嘛，主要就是检测下降沿或者上升沿嘛，这里笔者就以下降为例。<br>
先配置GPIO<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/e81c4d6d9cfd4fd1876767e6d30a9fe0.png" alt=""><br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/7d921be059c146e3afa943de9e950bc0.png" alt=""><br>
这里我们选择中断，不过我也趁机补充一下中断与事件的区别</p>
<blockquote>
<p>事件：是表示检测到某一动作（电平边沿）触发事件发生了。</p>
<p>中断：有某个事件发生并产生中断，并跳转到对应的中断处理程序中。</p>
</blockquote>
<p>中断有可能被更优先的中断屏蔽，事件不会。<br>
事件本质上就是一个触发信号,是用来触发特定的外设模块或核心本身(唤醒)。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/6f83d8d2e09243ec824773f44f0e2cae.png" alt=""><br>
在NVIC中使能这个EXTI<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/54fdf7d2e12b411fb337ab9f70a3d936.png" alt=""><br>
生成工程<br>
在/Core/Src/stm32xxx_it.c文件中找到我们的中断服务函数<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/79da663b4cc34256a26980a313a23d49.png" alt=""><br>
然后我们分析一下这个函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/136870d30d2a49198dbafb5043ffaa90.png" alt=""><br>
让我来解释一下这些API</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__HAL_GPIO_EXTI_GET_IT(GPIO_Pin) 		<span class="comment">//检查某个外部中断是否挂起</span></span><br><span class="line">__HAL_GPIO_EXTI_CLEAR_IT(GPIO_Pin); 	<span class="comment">//清除挂起标志位</span></span><br><span class="line">HAL_GPIO_EXTI_Callback(GPIO_Pin); 		<span class="comment">//调用回调函数</span></span><br></pre></td></tr></table></figure>
<p>一个外部中断进去了NVIC之后，它的外部中断挂起标志位就标志它现在正在挂起，等待执行，这个时候我们清除它的标志位，执行回调函数，一次外部中断就完成了。<br>
在HAL库中我们只需要再重写身为虚函数的回调函数就可以了。<br>
这里笔者选择在/Core/Src/stm32xxx_it.c重写回调函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* USER CODE BEGIN 1 */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">HAL_GPIO_EXTI_Callback</span><span class="params">(<span class="type">uint16_t</span> GPIO_Pin)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(GPIO_Pin == KEY1_Pin)</span><br><span class="line">	&#123;</span><br><span class="line">		HAL_GPIO_TogglePin(LED1_GPIO_Port, LED1_Pin);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* USER CODE END 1 */</span></span><br></pre></td></tr></table></figure>
<p>不过细心的朋友发现这个还是有一定的抖动，得做消抖于是加入了Delay延时，然后灯就亮一次就再也不灭了。<br>
<strong>原因是因为系统时钟设置里给滴答定时器的抢占优先级为15，所以在中断里调用HAL_Delay会卡死。</strong><br>
所以我们需要去调高滴答定时器的抢占优先级，调低中断的抢占优先级。<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/f3612182f9f446c29eaa72794800b96e.png" alt=""></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* USER CODE BEGIN 1 */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">HAL_GPIO_EXTI_Callback</span><span class="params">(<span class="type">uint16_t</span> GPIO_Pin)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(GPIO_Pin == KEY1_Pin)</span><br><span class="line">	&#123;</span><br><span class="line">		HAL_Delay(<span class="number">20</span>);</span><br><span class="line">		HAL_GPIO_TogglePin(LED1_GPIO_Port, LED1_Pin);</span><br><span class="line">		<span class="keyword">while</span>(HAL_GPIO_ReadPin(KEY1_GPIO_Port, KEY1_Pin) == GPIO_PIN_RESET);</span><br><span class="line">		HAL_Delay(<span class="number">20</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* USER CODE END 1 */</span></span><br></pre></td></tr></table></figure>
<p>OHHH！这样我们的按键就可以消抖成功了！</p>
<h2 id="6-7-修改hal库底层源码">6.7 修改HAL库底层源码</h2>
<p>不过，细心的朋友可能已经发现，现在只要我们快速连续点击按键，效果还是可能出错。<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img-blog.csdnimg.cn/a751aab7908f4c609fb674b6f1c0f7ab.png" alt=""><br>
这是因为HAL库的中断服务函数和我们的需求不符合造成的。HAL库的中断服务函数把清除中断挂起标志位放在中断回调函数的后面，这样确实很棒，因为后面要是有新的中断挂起申请，可以立马响应。不过，我们做按键就不希望这样，我们希望我们上一次的中断回调函数被完整执行了再处理下一次的指令（<strong>即先执行回调函数，执行完了再清除中断挂起标志位</strong>）。所以，我们修改这两句话的顺序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">HAL_GPIO_EXTI_IRQHandler</span><span class="params">(<span class="type">uint16_t</span> GPIO_Pin)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (__HAL_GPIO_EXTI_GET_IT(GPIO_Pin) != <span class="number">0x00</span>u)&#123;</span><br><span class="line">	  HAL_GPIO_EXTI_Callback(GPIO_Pin);</span><br><span class="line">    __HAL_GPIO_EXTI_CLEAR_IT(GPIO_Pin);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样，我们就得到了一个比较完善的按键检测了。<br>
不过，在你每次生成代码的时候这段代码都会被覆盖，这还是非常地让人upset。<br>
所以，我们直接模块化，作为我们新的积木代码。<br>
在笔者的HardWare 目录下面增加了exti文件，并且包含了头文件 exti.h，extic.c 文件。</p>
<p>exti.h</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by Whisky on 2023/1/10.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> HELLOWORLD_EXTI_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HELLOWORLD_EXTI_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;main.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">exti_init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//HELLOWORLD_EXTI_H</span></span></span><br></pre></td></tr></table></figure>
<p>exti.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by Whisky on 2023/1/10.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;exti.h&quot;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">exti_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    GPIO_InitTypeDef GPIO_Initure;</span><br><span class="line"></span><br><span class="line">    __HAL_RCC_GPIOA_CLK_ENABLE();               <span class="comment">//开启GPIOA时钟</span></span><br><span class="line">    __HAL_RCC_GPIOE_CLK_ENABLE();               <span class="comment">//开启GPIOE时钟</span></span><br><span class="line"></span><br><span class="line">    GPIO_Initure.Pin=GPIO_PIN_0;                <span class="comment">//PA0 ，这是正点原子战舰开发板的一个特殊按钮，连接的是VCC，所以为检测高电平有效</span></span><br><span class="line">    GPIO_Initure.Mode=GPIO_MODE_IT_RISING;      <span class="comment">//上升沿触发</span></span><br><span class="line">    GPIO_Initure.Pull=GPIO_PULLDOWN;</span><br><span class="line">    HAL_GPIO_Init(GPIOA,&amp;GPIO_Initure);</span><br><span class="line"></span><br><span class="line">    GPIO_Initure.Pin=GPIO_PIN_2|GPIO_PIN_3|GPIO_PIN_4; 	<span class="comment">//PE2,3,4</span></span><br><span class="line">    GPIO_Initure.Mode=GPIO_MODE_IT_FALLING;     <span class="comment">//下降沿触发</span></span><br><span class="line">    GPIO_Initure.Pull=GPIO_PULLUP;</span><br><span class="line">    HAL_GPIO_Init(GPIOE,&amp;GPIO_Initure);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//中断线0-PA0</span></span><br><span class="line">    HAL_NVIC_SetPriority(EXTI0_IRQn,<span class="number">2</span>,<span class="number">0</span>);       <span class="comment">//抢占优先级为2，子优先级为0</span></span><br><span class="line">    HAL_NVIC_EnableIRQ(EXTI0_IRQn);             <span class="comment">//使能中断线0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//中断线2-PE2</span></span><br><span class="line">    HAL_NVIC_SetPriority(EXTI2_IRQn,<span class="number">2</span>,<span class="number">1</span>);       <span class="comment">//抢占优先级为2，子优先级为1</span></span><br><span class="line">    HAL_NVIC_EnableIRQ(EXTI2_IRQn);             <span class="comment">//使能中断线2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//中断线3-PE3</span></span><br><span class="line">    HAL_NVIC_SetPriority(EXTI3_IRQn,<span class="number">2</span>,<span class="number">2</span>);       <span class="comment">//抢占优先级为2，子优先级为2</span></span><br><span class="line">    HAL_NVIC_EnableIRQ(EXTI3_IRQn);             <span class="comment">//使能中断线2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//中断线4-PE4</span></span><br><span class="line">    HAL_NVIC_SetPriority(EXTI4_IRQn,<span class="number">2</span>,<span class="number">3</span>);   	<span class="comment">//抢占优先级为2，子优先级为3</span></span><br><span class="line">    HAL_NVIC_EnableIRQ(EXTI4_IRQn);         	<span class="comment">//使能中断线4</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">KEY_GPIO_EXTI_IRQHandler</span><span class="params">(<span class="type">uint16_t</span> GPIO_Pin)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (__HAL_GPIO_EXTI_GET_IT(GPIO_Pin) != <span class="number">0x00</span>u)&#123;</span><br><span class="line">        HAL_GPIO_EXTI_Callback(GPIO_Pin);</span><br><span class="line">        __HAL_GPIO_EXTI_CLEAR_IT(GPIO_Pin);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//中断服务函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">EXTI0_IRQHandler</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    KEY_GPIO_EXTI_IRQHandler(GPIO_PIN_0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">EXTI2_IRQHandler</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    KEY_GPIO_EXTI_IRQHandler(GPIO_PIN_2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">EXTI3_IRQHandler</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    KEY_GPIO_EXTI_IRQHandler(GPIO_PIN_3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">EXTI4_IRQHandler</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    KEY_GPIO_EXTI_IRQHandler(GPIO_PIN_4);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">HAL_GPIO_EXTI_Callback</span><span class="params">(<span class="type">uint16_t</span> GPIO_Pin)</span></span><br><span class="line">&#123;</span><br><span class="line">    delay_ms(<span class="number">100</span>);      <span class="comment">//消抖</span></span><br><span class="line">    <span class="keyword">switch</span>(GPIO_Pin)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> GPIO_PIN_0:</span><br><span class="line">            <span class="keyword">if</span>(WK_UP==<span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                LED1(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> GPIO_PIN_2:</span><br><span class="line">            <span class="keyword">if</span>(KEY2==<span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                LED0(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> GPIO_PIN_3:</span><br><span class="line">            <span class="keyword">if</span>(KEY1==<span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">               LED0(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> GPIO_PIN_4:</span><br><span class="line">            <span class="keyword">if</span>(KEY0==<span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                LED1(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="6-8-不需要按的按钮-软中断">6.8 不需要按的按钮——软中断</h2>
<p>刚刚我们发现了中断框图里面有一个软件中断事件寄存器<br>
其实我们按下按钮的动作的事件可以靠软件模拟的，让我们来认识一下这个宏</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__HAL_GPIO_EXTI_GENERATE_SWIT(__EXTI_LINE__)</span><br></pre></td></tr></table></figure>
<p>于是我们在main.c里面模拟每一秒钟按下按钮</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* USER CODE BEGIN WHILE */</span></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)&#123;</span><br><span class="line">	  __HAL_GPIO_EXTI_GENERATE_SWIT(KEY1_Pin);</span><br><span class="line">	  delay_ms(<span class="number">1000</span>);</span><br><span class="line"><span class="comment">/* USER CODE END WHILE */</span></span><br></pre></td></tr></table></figure>
<p>这样，我们就有了一个每一秒钟自动按下的按钮啦。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://rich-blog.cn">瑞奇</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://rich-blog.cn/2023/01/10/STM32/%E6%8C%89%E4%B8%8B%E6%8C%89%E9%94%AE(%E5%90%ABEXTI)%E2%80%94%E2%80%94%E8%B7%9F%E6%88%91%E4%B8%80%E8%B5%B7%E5%86%99STM32(%E7%AC%AC%E5%9B%9B%E6%9C%9F)/">https://rich-blog.cn/2023/01/10/STM32/%E6%8C%89%E4%B8%8B%E6%8C%89%E9%94%AE(%E5%90%ABEXTI)%E2%80%94%E2%80%94%E8%B7%9F%E6%88%91%E4%B8%80%E8%B5%B7%E5%86%99STM32(%E7%AC%AC%E5%9B%9B%E6%9C%9F)/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://rich-blog.cn" target="_blank">瑞奇的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/stm32/">stm32</a><a class="post-meta__tags" href="/tags/%E5%8D%95%E7%89%87%E6%9C%BA/">单片机</a><a class="post-meta__tags" href="/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/">嵌入式</a><a class="post-meta__tags" href="/tags/c%E8%AF%AD%E8%A8%80/">c语言</a></div><div class="post_share"><div class="social-share" data-image="/img/cover/cover_9.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/01/11/STM32/%E4%B8%B2%E5%8F%A3(%E5%90%ABDMA)%E2%80%94%E2%80%94%E8%B7%9F%E6%88%91%E4%B8%80%E8%B5%B7%E5%86%99STM32(%E7%AC%AC%E4%BA%94%E6%9C%9F)/" title="串口(含DMA)——跟我一起写STM32(第五期)"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/cover_10.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">串口(含DMA)——跟我一起写STM32(第五期)</div></div></a></div><div class="next-post pull-right"><a href="/2023/01/10/STM32/%E6%A8%A1%E8%8C%83%E5%B7%A5%E7%A8%8B%E2%80%94%E2%80%94%E8%B7%9F%E6%88%91%E4%B8%80%E8%B5%B7%E5%86%99STM32(%E7%AC%AC%E4%B8%89%E6%9C%9F)/" title="模范工程——跟我一起写STM32(第三期)"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/cover_3.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">模范工程——跟我一起写STM32(第三期)</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/01/17/STM32/ADC%E5%92%8CDAC%E2%80%94%E2%80%94%E8%B7%9F%E6%88%91%E4%B8%80%E8%B5%B7%E5%86%99STM32(%E7%AC%AC%E4%B9%9D%E6%9C%9F)/" title="ADC和DAC——跟我一起写STM32(第九期)"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/cover_10.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-17</div><div class="title">ADC和DAC——跟我一起写STM32(第九期)</div></div></a></div><div><a href="/2023/01/15/STM32/%E2%80%9C1%EF%BC%8C2%EF%BC%8C3%EF%BC%8C%E5%AE%9A%E6%97%B6%E5%99%A8%E2%80%9D%E2%80%94%E2%80%94%E8%B7%9F%E6%88%91%E4%B8%80%E8%B5%B7%E5%86%99STM32(%E7%AC%AC%E5%85%AB%E6%9C%9F)/" title="“1，2，3，定时器”——跟我一起写STM32(第八期)"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/cover_15.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-15</div><div class="title">“1，2，3，定时器”——跟我一起写STM32(第八期)</div></div></a></div><div><a href="/2023/01/12/STM32/LCD(%E5%90%ABFSMC)%E2%80%94%E2%80%94%E8%B7%9F%E6%88%91%E4%B8%80%E8%B5%B7%E5%86%99STM32(%E7%AC%AC%E4%B8%83%E6%9C%9F)/" title="LCD(含FSMC)——跟我一起写STM32(第七期)"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/cover_3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-12</div><div class="title">LCD(含FSMC)——跟我一起写STM32(第七期)</div></div></a></div><div><a href="/2023/01/11/STM32/OLED(%E5%90%ABIIC)%E2%80%94%E2%80%94%E8%B7%9F%E6%88%91%E4%B8%80%E8%B5%B7%E5%86%99STM32(%E7%AC%AC%E5%85%AD%E6%9C%9F)/" title="OLED(含IIC)——跟我一起写STM32(第六期)"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/cover_10.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-11</div><div class="title">OLED(含IIC)——跟我一起写STM32(第六期)</div></div></a></div><div><a href="/2023/01/11/STM32/%E4%B8%B2%E5%8F%A3(%E5%90%ABDMA)%E2%80%94%E2%80%94%E8%B7%9F%E6%88%91%E4%B8%80%E8%B5%B7%E5%86%99STM32(%E7%AC%AC%E4%BA%94%E6%9C%9F)/" title="串口(含DMA)——跟我一起写STM32(第五期)"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/cover_10.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-11</div><div class="title">串口(含DMA)——跟我一起写STM32(第五期)</div></div></a></div><div><a href="/2023/01/10/STM32/%E6%A8%A1%E8%8C%83%E5%B7%A5%E7%A8%8B%E2%80%94%E2%80%94%E8%B7%9F%E6%88%91%E4%B8%80%E8%B5%B7%E5%86%99STM32(%E7%AC%AC%E4%B8%89%E6%9C%9F)/" title="模范工程——跟我一起写STM32(第三期)"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/cover_3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-10</div><div class="title">模范工程——跟我一起写STM32(第三期)</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/pearl.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">瑞奇</div><div class="author-info__description">一个心怀浪漫的少年</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">29</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://blog.csdn.net/DreamTrue520?spm=1011.2124.3001.5343"><i></i><span>🛴前往小家...</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="/info/wechat" target="_blank" title="WeChat"><i class="fab fa-weixin"></i></a><a class="social-icon" href="/info/qq" target="_blank" title="QQ"><i class="fab fa-qq"></i></a><a class="social-icon" href="https://github.com/mico845" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:1120845871@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来到我的博客！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#6-%E6%8C%89%E4%B8%8B%E6%8C%89%E9%94%AE"><span class="toc-text">6 按下按键</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E6%A3%80%E6%B5%8B%E4%B8%80%E4%B8%AA%E6%8C%89%E9%94%AE%E7%9A%84%E6%8C%89%E4%B8%8B"><span class="toc-text">6.1 检测一个按键的按下</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E7%BB%99%E6%8C%89%E9%94%AE%E6%B6%88%E6%8A%96"><span class="toc-text">6.2 给按键消抖</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-%E6%89%AB%E6%8F%8F%E6%8C%89%E9%94%AE"><span class="toc-text">6.3 扫描按键</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-%E5%BC%95%E5%85%A5%E4%B8%AD%E6%96%AD-%E4%B8%AD%E6%96%AD%E5%90%91%E9%87%8F%E8%A1%A8"><span class="toc-text">6.4 引入中断——中断向量表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-5-%E5%BC%95%E5%85%A5%E4%B8%AD%E6%96%AD-%E4%B8%AD%E6%96%AD%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-text">6.5 引入中断——中断优先级</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-6-%E6%8C%89%E9%94%AE%E7%9A%84%E6%A3%80%E6%B5%8B-%E5%A4%96%E9%83%A8%E4%B8%AD%E6%96%ADexti"><span class="toc-text">6.6 按键的检测——外部中断EXTI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-7-%E4%BF%AE%E6%94%B9hal%E5%BA%93%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81"><span class="toc-text">6.7 修改HAL库底层源码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-8-%E4%B8%8D%E9%9C%80%E8%A6%81%E6%8C%89%E7%9A%84%E6%8C%89%E9%92%AE-%E8%BD%AF%E4%B8%AD%E6%96%AD"><span class="toc-text">6.8 不需要按的按钮——软中断</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By 瑞奇</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="30" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script defer src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/hexo-tag-plugins@latest/lib/mindmap.min.js"></script><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><!-- hexo injector body_end end --></body></html>